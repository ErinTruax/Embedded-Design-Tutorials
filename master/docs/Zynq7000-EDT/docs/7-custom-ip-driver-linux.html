


<!DOCTYPE HTML>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
	<head>
		<meta charset="utf-8">
		
		<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
		<link rel="stylesheet" href="https://static.cloud.coveo.com/searchui/v2.4382/css/CoveoFullSearch.css"/>
		<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<meta name="description"/>
		<meta name="keywords"/>
		<meta property="og:title" content=""/>
		<meta property="og:description"/>
		<!-- favicon -->
		<link rel="icon" type="image/vnd.microsoft.icon" href="../../_static/favicon.ico"/>
		<link rel="shortcut icon" type="image/vnd.microsoft.icon" href="../../_static/favicon.ico"/>
		<!-- Fonts -->
		<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet" type="text/css"/>

  
  
  
  

  
      <script type="text/javascript" src="../../_static/js/jquery.min.js"></script>
	  <script type="text/javascript" src="../../_static/js/gtm.js"></script>
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
    <script type="text/javascript" src="../../_static/js/d3dd8c60ed.js"></script>
    <script type="text/javascript" src="../../_static/js/common-ui-all.min.js"></script>
    <script type="text/javascript" src="../../_static/js/header-footer.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="../../_static/js/CoveoJsSearch.Lazy.min.js"></script>
    <script type="text/javascript" src="../../_static/js/linkid.js"></script>
    <script type="text/javascript" src="../../_static/js/Searchbox.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/common-ui-all.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/header-footer.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/pro.min.css" media="all" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
	</head>
	<body>
		<div class="xilinx-bs3"/>
		<div class="root responsivegrid">
			<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 aem-Grid--large--16 aem-Grid--xlarge--16 aem-Grid--xxlarge--16 aem-Grid--xxxlarge--16 ">
				<div class="xilinxExperienceFragments experiencefragment aem-GridColumn aem-GridColumn--default--12">
					<div class="xf-content-height">
						<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 ">
							<div class="header parbase aem-GridColumn aem-GridColumn--default--12">
								<noindex>
									<header data-component="header">
										<nav class="navbar navbar-default aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid main-nav">
													<div class="row">
														<div class="col-xs-12">
															<div class="logo-column">
																<div class="logo">
																	<a href="https://www.xilinx.com/">
																	<img src="https://www.xilinx.com/etc.clientlibs/site/clientlibs/xilinx/all/resources/imgs/header/xilinx-header-logo.svg" title="Xilinx Inc"/>
																	</a>
																</div>
															</div>
															<div class="navbar-column">
																<div class="navbar navbar-collapse collapse" id="xilinx-main-menu">
																	<div class="mobile-search-container">
																		<div id="headerSearchBox" class="headerSearch"
																			data-component="header-search"
																			data-redirect-if-empty="false"
																			data-coveo-access-token="xxa237d4dd-f0aa-47fc-9baa-af9121851b33"
																			data-coveo-organization-id="xilinxcomprode2rjoqok">
																			<div class='coveo-search-section'>
																				<div class="CoveoAnalytics" data-search-hub="Site"></div>
																				<ul class="dropdown-menu options">
																					<li class="option" data-label="All" data-action-link="https://www.xilinx.com/search/site-keyword-search.html" data-search-hub="Site">
																						<a href="#">
																						All</a>
																					</li>
																					<li data-label="Silicon Devices" data-action-link="https://www.xilinx.com//products/silicon-devices/si-keyword-search.html" data-search-hub="Product">
																						<a href="#">
																						Silicon Devices</a>
																					</li>
																					<li data-label="Boards and Kits" data-action-link="https://www.xilinx.com//products/boards-and-kits/bk-keyword-search.html" data-search-hub="Product">
																						<a href="#">
																						Boards and Kits</a>
																					</li>
																					<li data-label="Intellectual Property" data-action-link="https://www.xilinx.com//products/intellectual-property/ip-keyword-search.html" data-search-hub="Product">
																						<a href="#">
																						Intellectual Property</a>
																					</li>
																					<li data-label="Support" class="option" data-action-link="https://www.xilinx.com/search/support-keyword-search.html" data-search-hub="Support">
																						<a href="#">
																						Support</a>
																						<ul>
																							<li data-label="Documentation" data-action-link="https://www.xilinx.com//support/documentation-navigation/documentation-keyword-search.html" data-search-hub="Document">
																								<a href="#">
																								Documentation</a>
																							</li>
																							<li data-label="Knowledge Base" data-action-link="https://www.xilinx.com//support/answer-navigation/answer-keyword-search.html" data-search-hub="AnswerRecord">
																								<a href="#">
																								Knowledge Base</a>
																							</li>
																							<li data-label="Community Forums" data-action-link="https://www.xilinx.com/search/forums-keyword-search.html" data-search-hub="Forums">
																								<a href="#">
																								Community Forums</a>
																							</li>
																						</ul>
																					</li>
																					<li data-label="Partners" data-action-link="https://www.xilinx.com//alliance/member-keyword-search.html" data-search-hub="Partner">
																						<a href="#">
																						Partners</a>
																					</li>
																					<li data-label="Videos" data-action-link="https://www.xilinx.com/video/video-keyword-search.html" data-search-hub="Video">
																						<a href="#">
																						Videos</a>
																					</li>
																					<li data-label="Press" data-action-link="https://www.xilinx.com/search/press-keyword-search.html" data-search-hub="Press">
																						<a href="#">
																						Press</a>
																					</li>
																				</ul>
																				<a href="#" class="btn dropdown-toggle value" data-toggle="dropdown"></a>
																				<div class="CoveoSearchbox" data-id="coveosearchbox" data-action-link="https://www.xilinx.com/search/site-keyword-search.html" data-placeholder="Search Xilinx"></div>
																			</div>
																		</div>
																	</div>
																	<ul class="nav navbar-nav nav-justified">
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://www.xilinx.com/applications.html">
																			Applications</a>
																		</li>
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://www.xilinx.com/products/silicon-devices.html">
																			Products</a>
																		</li>
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://developer.xilinx.com/">
																			Developers</a>
																		</li>
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://www.xilinx.com/support.html">
																			Support</a>
																		</li>
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://www.xilinx.com/about/company-overview.html">
																			About</a>
																		</li>
																	</ul>
																</div>
															</div>
															<script type="text/javascript" src="../../_static/js/gtm.js"></script>
															<!--<div class="mini-nav">
																<button type="button" data-function="xilinx-mobile-menu" id="nav-toggle" class="navbar-toggle collapsed visible-xs-block" aria-expanded="false">
																<span></span>
																<span></span>
																<span></span>
																<span></span>
																</button>
																<ul class="list-inline">
																	<li class="dropdown user-menu">
																		<button data-toggle="dropdown">
																		<span class="sr-only">Account</span>
																		<span class="fas fa-user"></span>
																		</button>
																		<ul class="dropdown-menu">
																			<li>
																				<a href="https://www.xilinx.com/myprofile/subscriptions.html">
																				My Account</a>
																			</li>
																			<li>
																				<a href="https://www.xilinx.com/registration/create-account.html">
																				Create Account</a>
																			</li>
																			<li>
																				<a href="https://www.xilinx.com/bin/protected/en/signout">
																				Sign Out</a>
																			</li>
																		</ul>
																	</li>
																	<li class="hidden-xs">
																		<button data-function="search-toggle">
																		<span class="sr-only">Search</span>
																		<span class="far fa-search"></span>
																		</button>
																	</li>
																</ul>
															</div>
															-->
															<div class="search-container">
																<div id="headerSearchBox" class="headerSearch"
																	data-component="header-search"
																	data-redirect-if-empty="false"
																	data-coveo-access-token="xxa237d4dd-f0aa-47fc-9baa-af9121851b33"
																	data-coveo-organization-id="xilinxcomprode2rjoqok">
																	<div class='coveo-search-section'>
																		<div class="CoveoAnalytics" data-search-hub="Site"></div>
																		<ul class="dropdown-menu options">
																			<li class="option" data-label="All" data-action-link="https://www.xilinx.com/search/site-keyword-search.html" data-search-hub="Site">
																				<a href="#">
																				All</a>
																			</li>
																			<li data-label="Silicon Devices" data-action-link="https://www.xilinx.com/products/silicon-devices/si-keyword-search.html" data-search-hub="Product">
																				<a href="#">
																				Silicon Devices</a>
																			</li>
																			<li data-label="Boards and Kits" data-action-link="https://www.xilinx.com/products/boards-and-kits/bk-keyword-search.html" data-search-hub="Product">
																				<a href="#">
																				Boards and Kits</a>
																			</li>
																			<li data-label="Intellectual Property" data-action-link="https://www.xilinx.com/products/intellectual-property/ip-keyword-search.html" data-search-hub="Product">
																				<a href="#">
																				Intellectual Property</a>
																			</li>
																			<li data-label="Support" class="option" data-action-link="https://www.xilinx.com/search/support-keyword-search.html" data-search-hub="Support">
																				<a href="#">
																				Support</a>
																				<ul>
																					<li data-label="Documentation" data-action-link="https://www.xilinx.com/support/documentation-navigation/documentation-keyword-search.html" data-search-hub="Document">
																						<a href="#">
																						Documentation</a>
																					</li>
																					<li data-label="Knowledge Base" data-action-link="https://www.xilinx.com/support/answer-navigation/answer-keyword-search.html" data-search-hub="AnswerRecord">
																						<a href="#">
																						Knowledge Base</a>
																					</li>
																					<li data-label="Community Forums" data-action-link="https://www.xilinx.com/search/forums-keyword-search.html" data-search-hub="Forums">
																						<a href="#">
																						Community Forums</a>
																					</li>
																				</ul>
																			</li>
																			<li data-label="Partners" data-action-link="https://www.xilinx.com/alliance/member-keyword-search.html" data-search-hub="Partner">
																				<a href="#">
																				Partners</a>
																			</li>
																			<li data-label="Videos" data-action-link="https://www.xilinx.com/video/video-keyword-search.html" data-search-hub="Video">
																				<a href="#">
																				Videos</a>
																			</li>
																			<li data-label="Press" data-action-link="https://www.xilinx.com/search/press-keyword-search.html" data-search-hub="Press">
																				<a href="#">
																				Press</a>
																			</li>
																		</ul>
																		<a href="#" class="btn dropdown-toggle value" data-toggle="dropdown"></a>
																		<div class="CoveoSearchbox" data-id="coveosearchbox" data-action-link="https://www.xilinx.com/search/site-keyword-search.html" data-placeholder="Search Xilinx"></div>
																	</div>
																</div>
																<button data-function="search-toggle">
																<span class="sr-only">Search</span>
																<span class="far fa-times"></span>
																</button>
															</div>
														</div>
													</div>
												</div>
											</div>
										</nav>
									</header>
								</noindex>
							</div>
						</div>
					</div>
				</div>
				<div class="parsys aem-GridColumn--xxxlarge--none aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
						<div class="container-fluid">
							<div class="row">
							<div class="col-xs-12">
   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Embedded Design Tutorials
          

          
          </a>

          
            
            
              <div class="version">
                2020.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

      
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
            
            
            
              
            
            
              <p class="caption"><span class="caption-text">Versions</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/Xilinx/Embedded-Design-Tutorials/tree/master">Master</a></li>
</ul>

            
			
			<p class="caption"><span class="caption-text">This Page</span></p>
				<ul class="current">
				  <li class="toctree-l1"><a href="../../_sources/Zynq7000-EDT/docs/7-custom-ip-driver-linux.md.txt"
						rel="nofollow">Show Source</a></li>
				</ul>
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Embedded Design Tutorials</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Creating Custom IP and Device Driver for Linux</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/Zynq7000-EDT/docs/7-custom-ip-driver-linux.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <p align="right">
            Read this page in other languages:<a href="../docs-jp/7-custom-ip-driver-linux.md">日本語</a>    <table style="width:100%"><table style="width:100%">
  <tr><th width="100%" colspan="6"><img src="https://www.xilinx.com/content/dam/xilinx/imgs/press/media-kits/corporate/xilinx-logo.png" width="30%"/><h1>Zynq-7000 SoC Embedded Design Tutorial 2020.2 (UG1165)</h1>
</th>  </tr>
  <tr>
    <td width="33%" align="center"><a href="../README.md">1. Introduction</a></td>
    <td width="33%" align="center"><a href="2-using-zynq.md">2. Using the Zynq SoC Processing System</a></td>
    <td width="33%" align="center"><a href="3-using-gp-port-zynq.md">3. Using the GP Port in Zynq Devices</a></td>
</tr>
<tr><td width="33%" align="center"><a href="4-debugging-vitis.md">4. Debugging with the Vitis Software Platform</a></td>
    <td width="33%" align="center"><a href="5-using-hp-port.md">5. Using the HP Slave Port with AXI CDMA IP</a></td>
    <td width="33%" align="center"><a href="6-linux-booting-debug.md">6. Linux Booting and Debug in the Vitis Software Platform</a></td>
  </tr>
  <tr>
      <td width="33%" align="center">7. Creating Custom IP and Device Driver for Linux</td>
      <td width="33%" align="center"><a href="8-sw-profiling.md">8. Software Profiling Using the Vitis Software Platform</a></td>    
      <td width="33%" align="center"><a href="9-linux-aware-debugging.md">9. Linux Aware Debugging</a></td>    
    </tr>
</table><ul class="simple">
<li><p><a class="reference external" href="#creating-custom-ip-and-device-driver-for-linux">Creating Custom IP and Device Driver for Linux</a></p>
<ul>
<li><p><a class="reference external" href="#requirements">Requirements</a></p></li>
<li><p><a class="reference external" href="#creating-peripheral-ip">Creating Peripheral IP</a></p>
<ul>
<li><p><a class="reference external" href="#example-project-creating-peripheral-ip">Example Project: Creating Peripheral IP</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#integrating-peripheral-ip-with-ps-gp-master-port">Integrating Peripheral IP with PS GP Master Port</a></p>
<ul>
<li><p><a class="reference external" href="#connecting-an-axi4-lite-compliant-custom-slave-ip">Connecting an AXI4-Lite Compliant Custom Slave IP</a></p></li>
<li><p><a class="reference external" href="#example-project-device-driver-development">Example Project: Device Driver Development</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#loading-module-into-running-kernel-and-application-execution">Loading Module into Running Kernel and Application Execution</a></p>
<ul>
<li><p><a class="reference external" href="#loading-module-into-kernel-memory">Loading Module into Kernel Memory</a></p></li>
<li><p><a class="reference external" href="#application-software">Application Software</a></p></li>
<li><p><a class="reference external" href="#example-project-loading-a-module-into-kernel-and-executing-the-application">Example Project: Loading a Module into Kernel and Executing the Application</a></p>
<ul>
<li><p><a class="reference external" href="#booting-linux-on-the-target-board"><em>Booting Linux on the Target Board</em></a></p></li>
<li><p><a class="reference external" href="#loading-modules-and-executing-applications">Loading Modules and Executing Applications</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="section" id="creating-custom-ip-and-device-driver-for-linux">
<h1>Creating Custom IP and Device Driver for Linux<a class="headerlink" href="#creating-custom-ip-and-device-driver-for-linux" title="Permalink to this headline">¶</a></h1>
<p>In this chapter, you will create an intellectual property (IP) using
the Create and Package New IP wizard. You will also design a system to
include the new IP created for the Xilinx® Zynq®-7000 SoC device.</p>
<p>For the IP, you will develop a Linux-based device driver as a module
that can be dynamically loaded onto the running kernel.</p>
<p>You will also develop Linux-based application software for the system
to execute on the Zynq SoC ZC702 board.</p>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p>In this chapter, the target platform points to a ZC702 board. The host
platform points a Windows machine that is running the Vivado® Design
Suite tools.</p>
<p>The requirements for Linux-based device driver development and kernel
compilation are as follows:</p>
<ul class="simple">
<li><p>Linux-based workstation. The workstation is used to build the kernel
and the device driver for the IP.</p></li>
<li><p>An Eclipse-based integrated development environment (IDE) that
incorporates the GNU Toolchain for cross development for target
architectures.</p></li>
<li><p>Kernel source code and build environment. Refer to the <a href="http://wiki.xilinx.com/zynq-linux">Xilinx Zynq
Linux Wiki Page</a>, which
provides details about the Linux kernel specific to Zynq SoC
FPGAs. You can download the Kernel Source files and also get the
information for building a Linux kernel for the Zynq SoC FPGA.</p></li>
</ul>
<p><strong><em>Note</em>:</strong> You can download kernel source files and u-boot source
files from the <a href="https://github.com/xilinx">Xilinx GitHub website</a>.</p>
<ul>
<li><p>Device driver software file (blink.c) and the corresponding header
file (blink.h). These files are available in the ZIP file that
accompanies this guide. See <a class="reference external" href="2-using-zynq.md#design-files-for-this-tutorial">Design Files for This
Tutorial</a>.</p></li>
<li><p>Application software (linux_blinkled_apps.c) and corresponding
header file (blink.h). These files are available in the ZIP file
that accompanies this guide. See <a class="reference external" href="2-using-zynq.md#design-files-for-this-tutorial">Design Files for This
Tutorial</a>.</p></li>
<li><p>If you want to skip the kernel and
device driver compilation, use the already compiled images that
are required for this section. These images are available in the
ZIP file that accompanies this guide. See <a class="reference external" href="2-using-zynq.md#design-files-for-this-tutorial">Design Files for This
Tutorial</a>.</p>
<p><img alt="../../_images/image92.png" src="../../_images/image92.png" /></p>
</li>
</ul>
<p><strong>CAUTION!</strong> *You must build Peripheral IP loadable kernel module
(LKM) as part of the same kernel build process that generates the base
kernel image. If you want to skip kernel or LKM Build process, use the
precompiled images for both kernel and LKM module for this section
provided in the ZIP file that accompanies this guide.</p>
</div>
<div class="section" id="creating-peripheral-ip">
<h2>Creating Peripheral IP<a class="headerlink" href="#creating-peripheral-ip" title="Permalink to this headline">¶</a></h2>
<p>In this section, you will create an AXI4-Lite compliant slave
peripheral IP framework using the Create and Package New IP wizard.
You will also add functionality and port assignments to the peripheral
IP framework.</p>
<p>The Peripheral IP you will create is an AXI4-Lite compliant slave IP.
It includes a 28-bit counter. The 4 MSB bits of the counter drive the
4 output ports of the peripheral IP. The block diagram is shown in the
following figure.</p>
<p><img alt="../../_images/image93.jpeg" src="../../_images/image93.jpeg" /></p>
<p>The block diagram includes the following configuration register:</p>
<p>Register Name      Control Register</p>
<hr class="docutils" />
<p>Relative Address   0x0000_0000
Width              1 bit
Access Type        Read/Write
Description        Start/Stop the Counter</p>
  <table>
  <thead>
  <tr class="header">
  <th><blockquote>
  <p><strong>Field Name</strong></p>
  </blockquote></th>
  <th><blockquote>
  <p><strong>Bits</strong></p>
  </blockquote></th>
  <th><blockquote>
  <p><strong>Type</strong></p>
  </blockquote></th>
  <th><blockquote>
  <p><strong>Reset Value</strong></p>
  </blockquote></th>
  <th><blockquote>
  <p><strong>Description</strong></p>
  </blockquote></th>
  </tr>
  </thead>
  <tbody>
  <tr class="odd">
  <td>Control Bit</td>
  <td>0</td>
  <td>R/W</td>
  <td>0x0</td>
  <td><blockquote>
  <p>1 : Start Counter 2 : Stop Counter</p>
  </blockquote></td>
  </tr>
  </tbody>
  </table><div class="section" id="example-project-creating-peripheral-ip">
<h3>Example Project: Creating Peripheral IP<a class="headerlink" href="#example-project-creating-peripheral-ip" title="Permalink to this headline">¶</a></h3>
<p>In this section, you will create an AXI4-Lite compliant slave
peripheral IP.</p>
<ol>
<li><p>Create a new project as described in <a class="reference external" href="2-using-zynq.md#example-project-creating-a-new-embedded-project-with-zynq-soc">Example Project: Creating a New Embedded Project with Zynq SoC</a>.</p></li>
<li><p>With the Vivado design open, select <strong>Tools → Create and Package New
IP</strong>. Click <strong>Next</strong> to continue.</p></li>
<li><p>Select <strong>Create a new AXI4 peripheral</strong> and then click <strong>Next</strong>.</p></li>
<li><p>Fill in the peripheral details as follows:</p>
<table>
<thead>
<tr class="header">
<th><blockquote>
<p><strong>Wizard Screen</strong></p>
</blockquote></th>
<th><blockquote>
<p><strong>System Property</strong></p>
</blockquote></th>
<th><blockquote>
<p><strong>Setting or Comment to Use</strong></p>
</blockquote></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Peripheral Details</td>
<td>Name</td>
<td>Blink</td>
</tr>
<tr class="even">
<td></td>
<td>Version</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td></td>
<td>Display name</td>
<td>Blink_v1.0</td>
</tr>
<tr class="even">
<td></td>
<td>Description</td>
<td>My new AXI IP</td>
</tr>
<tr class="odd">
<td></td>
<td>IP location</td>
<td>C:/designs/ip_repro</td>
</tr>
<tr class="even">
<td></td>
<td>Overwrite existing</td>
<td>unchecked</td>
</tr>
</tbody>
</table></li>
<li><p>Click <strong>Next</strong>.</p></li>
<li><p>In the Add Interfaces page, accept the default settings and click
<strong>Next</strong>.</p></li>
<li><p>In the Create Peripheral page, select <strong>Edit IP</strong> and then click <strong>Finish</strong>. Upon completion of the new IP generation process, the Package IP window opens (see the following figure).</p>
<p><img alt="../../_images/image94.png" src="../../_images/image94.png" /></p>
</li>
<li><p>In the Hierarchy view of the <strong>Sources</strong> window, right-click
<strong>blink_v1_0</strong> under the Design Sources folder and select <strong>Open
File</strong>. We will need to add Verilog code that creates output ports
to map to the external LEDs on the ZC702 board. Navigate to the
line <code class="docutils literal notranslate"><span class="pre">//Users</span> <span class="pre">to</span> <span class="pre">add</span> <span class="pre">ports</span> <span class="pre">here</span></code> and add <code class="docutils literal notranslate"><span class="pre">output</span> <span class="pre">wire</span> <span class="pre">\[3:0\]</span> <span class="pre">leds</span></code>
below this line, as shown in the following example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">Users</span> <span class="n">to</span> <span class="n">add</span> <span class="n">ports</span> <span class="n">here</span>
<span class="n">output</span> <span class="n">wire</span> <span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">leds</span><span class="p">,</span>
<span class="o">//</span><span class="n">User</span> <span class="n">ports</span> <span class="n">ends</span>
</pre></div>
</div>
</li>
<li><p>Find the instance instantiation to the AXI bus interface and add
.leds(leds) as shown in the following example to map the port
connections:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">.</span><span class="n">S_AXI_RREADY</span><span class="p">(</span><span class="n">s00_axi_rready</span><span class="p">),</span>
  <span class="o">.</span><span class="n">leds</span><span class="p">(</span><span class="n">leds</span><span class="p">)</span>
  <span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Save and close blink_v1_0.v.</p></li>
<li><p>Under <strong>Sources→ Hierarchy → Design Sources→ blink_v1_0</strong>, right-click blink_v1_0_S00_AXI_inst - blink_v1_0_S00_AXI and select Open File.</p>
<p>Next, you will need to add Verilog code that creates output ports to
map to the external LEDs on the ZC702 board and also create the logic
code to blink the LEDs when Register 0 is written to.</p>
</li>
<li><p>Navigate to the line <code class="docutils literal notranslate"><span class="pre">//Users</span> <span class="pre">to</span> <span class="pre">add</span> <span class="pre">ports</span> <span class="pre">here</span></code> and add <code class="docutils literal notranslate"><span class="pre">output</span> <span class="pre">wire</span> <span class="pre">\[3:0\]</span> <span class="pre">leds</span></code> below this line, as shown in the example below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">Users</span> <span class="n">to</span> <span class="n">add</span> <span class="n">ports</span> <span class="n">here</span>
<span class="n">output</span> <span class="n">wire</span> <span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">leds</span><span class="p">,</span>
<span class="o">//</span><span class="n">User</span> <span class="n">ports</span> <span class="n">ends</span>
</pre></div>
</div>
</li>
<li><p>Find the AXI4-Lite signals section:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">AXI4LITE</span> <span class="n">signals</span>
  <span class="n">reg</span> <span class="p">[</span><span class="n">C_S_AXI_ADDR_WIDTH</span><span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="mi">0</span><span class="p">]</span> <span class="n">axi_awaddr</span><span class="p">;</span>
  <span class="n">reg</span> <span class="n">axi_awready</span><span class="p">;</span>
  <span class="n">reg</span> <span class="n">axi_wready</span><span class="p">;</span>
  <span class="n">reg</span> <span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="mi">0</span><span class="p">]</span> <span class="n">axi_bresp</span><span class="p">;</span>
  <span class="n">reg</span> <span class="n">axi_bvalid</span><span class="p">;</span>
  <span class="n">reg</span> <span class="p">[</span><span class="n">C_S_AXI_ADDR_WIDTH</span><span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="mi">0</span><span class="p">]</span> <span class="n">axi_araddr</span><span class="p">;</span>
  <span class="n">reg</span> <span class="n">axi_arready</span><span class="p">;</span>
  <span class="n">reg</span> <span class="p">[</span><span class="n">C_S_AXI_DATA_WIDTH</span><span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="mi">0</span><span class="p">]</span> <span class="n">axi_rdata</span><span class="p">;</span>
  <span class="n">reg</span> <span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="mi">0</span><span class="p">]</span> <span class="n">axi_rresp</span><span class="p">;</span>
  <span class="n">reg</span> <span class="n">axi_rvalid</span><span class="p">;</span>
</pre></div>
</div>
<p>After this section , you will now add a custom register, which you
will use as a counter. Add the following code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">add</span> <span class="mi">28</span><span class="o">-</span><span class="n">bit</span> <span class="n">register</span> <span class="n">to</span> <span class="n">use</span> <span class="k">as</span> <span class="n">counter</span>
<span class="n">reg</span> <span class="p">[</span><span class="mi">27</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">count</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>Find the I/O connections assignments section:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">Connections</span> <span class="n">assignments</span>
  <span class="n">assign</span> <span class="n">S_AXI_AWREADY</span> <span class="o">=</span> <span class="n">axi_awready</span><span class="p">;</span>
  <span class="n">assign</span> <span class="n">S_AXI_WREADY</span> <span class="o">=</span> <span class="n">axi_wready</span><span class="p">;</span>
  <span class="n">assign</span> <span class="n">S_AXI_BRESP</span> <span class="o">=</span> <span class="n">axi_bresp</span><span class="p">;</span>
  <span class="n">assign</span> <span class="n">S_AXI_BVALID</span> <span class="o">=</span> <span class="n">axi_bvalid</span><span class="p">;</span>
  <span class="n">assign</span> <span class="n">S_AXI_ARREADY</span> <span class="o">=</span> <span class="n">axi_arready</span><span class="p">;</span>
  <span class="n">assign</span> <span class="n">S_AXI_RDATA</span> <span class="o">=</span> <span class="n">axi_rdata</span><span class="p">;</span>
  <span class="n">assign</span> <span class="n">S_AXI_RRESP</span> <span class="o">=</span> <span class="n">axi_rresp</span><span class="p">;</span>
  <span class="n">assign</span> <span class="n">S_AXI_RVALID</span> <span class="o">=</span> <span class="n">axi_rvalid</span><span class="p">;</span>
</pre></div>
</div>
<p>Add the following code at the bottom:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">assign</span> <span class="n">MSB</span> <span class="n">of</span> <span class="n">count</span> <span class="n">to</span> <span class="n">LEDs</span>
  <span class="n">assign</span> <span class="n">leds</span> <span class="o">=</span> <span class="n">count</span><span class="p">[</span><span class="mi">27</span><span class="p">:</span><span class="mi">24</span><span class="p">];</span>
</pre></div>
</div>
</li>
<li><p>Toward the bottom of the file, find the section that states add user
logic here. Add the following code, which will increment count
while the slv_reg0 is set to 0x1. If the register is not set, the
counter does not increment.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Add</span> <span class="n">user</span> <span class="n">logic</span> <span class="n">here</span>
  <span class="o">//</span> <span class="n">on</span> <span class="n">positive</span> <span class="n">edge</span> <span class="n">of</span> <span class="nb">input</span> <span class="n">clock</span>
  <span class="n">always</span> <span class="o">@</span><span class="p">(</span> <span class="n">posedge</span> <span class="n">S_AXI_ACLK</span> <span class="p">)</span>
  <span class="n">begin</span>
  <span class="o">//</span><span class="k">if</span> <span class="n">reset</span> <span class="ow">is</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">set</span> <span class="n">count</span> <span class="o">=</span> <span class="mh">0x0</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">S_AXI_ARESETN</span> <span class="o">==</span> <span class="mi">1</span><span class="s1">&#39;b0 )</span>
  <span class="n">begin</span>
  <span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">28</span><span class="s1">&#39;b0;</span>
  <span class="n">end</span>
  <span class="k">else</span>
  <span class="n">begin</span>
  <span class="o">//</span><span class="n">when</span> <span class="n">slv_reg_0</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="mh">0x1</span><span class="p">,</span> <span class="n">increment</span> <span class="n">count</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">slv_reg0</span> <span class="o">==</span> <span class="mi">2</span><span class="s1">&#39;h01)</span>
  <span class="n">begin</span>
  <span class="n">count</span> <span class="o">&lt;=</span> <span class="n">count</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
  <span class="n">end</span>
  <span class="k">else</span>
  <span class="n">begin</span>
  <span class="n">count</span> <span class="o">&lt;=</span> <span class="n">count</span><span class="p">;</span>
  <span class="n">end</span>
  <span class="n">end</span>
  <span class="n">end</span>
  <span class="o">//</span> <span class="n">User</span> <span class="n">logic</span> <span class="n">ends</span>
</pre></div>
</div>
</li>
<li><p>Save and close blink_v1_0_S00_AXI.v.</p></li>
<li><p>Open the <strong>Package IP - blink</strong> page. Under <strong>Packaging Steps</strong>,
select <strong>Ports and Interfaces</strong>.</p></li>
<li><p>Click the <strong>Merge Changes from Ports and Interfaces Wizard</strong> link.</p>
<p><img alt="../../_images/image95.png" src="../../_images/image95.png" /></p>
</li>
<li><p>Make sure that the window is updated and includes the LEDs output ports.</p>
<p><img alt="../../_images/image96.png" src="../../_images/image96.png" /></p>
</li>
<li><p>Under Packaging Steps, select <strong>Review and Package</strong>. At the bottom
of the Review and Package page, click <strong>Re-Package IP</strong>.</p>
<p>The view that opens states that packaging is complete and asks if you
would like to close the project.</p>
</li>
<li><p>Click <strong>Yes</strong>.</p></li>
</ol>
<p><strong><em>Note</em>:</strong> The custom core creation process that we have worked
through is very simple with the example Verilog included in the IP
creation process. For more information, refer to the GitHub Zynq
Cookbook: How to Run BFM Simulation <a href="https://github.com/imrickysu/ZYNQ-Cookbook/wiki/How-to-run-BFM-simulation">web page</a>.</p>
</div>
</div>
<div class="section" id="integrating-peripheral-ip-with-ps-gp-master-port">
<h2>Integrating Peripheral IP with PS GP Master Port<a class="headerlink" href="#integrating-peripheral-ip-with-ps-gp-master-port" title="Permalink to this headline">¶</a></h2>
<p>Now, you will create a system for the ZC702 board by instantiating the
peripheral IP as a slave in the Zynq SoC programmable logic (PL)
section. You will then connect it with the PS processor through the
processing system (PS) general purpose (GP) master port. The block
diagram for the system is shown in the following figure.</p>
<p><img alt="../../_images/image97.jpeg" src="../../_images/image97.jpeg" /></p>
<p>This system covers the following connections:</p>
<ul class="simple">
<li><p>Peripheral IP connected to PS General Purpose master port 0
(M_AXI_GP0). This connection is used by the PS CPU to configure
Peripheral IP register configurations.</p></li>
<li><p>Four output ports of Peripheral IP connected to DS15, DS16, DS17,
and DS18 on-board LEDs.</p></li>
</ul>
<p>In this system, when you run application code, a message appears on
the serial terminal and asks you to choose the option to make the LEDs
start or stop blinking.</p>
<ul class="simple">
<li><p>When you select the start option on the serial terminal, all four
LEDs start blinking.</p></li>
<li><p>When you select the stop option, all four LEDs stop blinking and
retain the previous state.</p></li>
</ul>
<div class="section" id="connecting-an-axi4-lite-compliant-custom-slave-ip">
<h3>Connecting an AXI4-Lite Compliant Custom Slave IP<a class="headerlink" href="#connecting-an-axi4-lite-compliant-custom-slave-ip" title="Permalink to this headline">¶</a></h3>
<p>In this section, you will connect an AXI4-Lite compliant custom slave
peripheral IP that you created in <a class="reference external" href="#example-project-creating-peripheral-ip">Example Project: Creating
Peripheral IP</a>.</p>
<ol>
<li><p>Open the Vivado project you previously created in <a class="reference external" href="2-using-zynq.md#example-project-creating-a-new-embedded-project-with-zynq-soc">Example Project:
Creating a New Embedded Project with Zynq
SoC</a>.</p></li>
<li><p>Add the custom IP to the existing design. Right-click the Diagram
view and select <strong>Add IP</strong>.</p></li>
<li><p>Type blink into the search view. Blink_v1.0 appears. Double-click
the IP to add it to the design.</p></li>
<li><p>Click <strong>Run Connection Automation</strong> to make automatic port
connections.</p></li>
<li><p>With the <strong>All Automation</strong> box checked by default, click <strong>OK</strong> to
make the connections. Your new IP is automatically connected but
the leds output port is unconnected.</p></li>
<li><p>Right-click the <strong>leds</strong> port and select <strong>Make External</strong>.</p>
<p><img alt="../../_images/image98.jpeg" src="../../_images/image98.jpeg" /></p>
</li>
<li><p>In the Flow Navigator view, navigate to <strong>RTL Analysis</strong> and select
<strong>Open Elaborated Design</strong>.</p></li>
<li><p>Click <strong>OK</strong>.</p></li>
<li><p>After the elaborated design opens, click the <strong>I/O Ports</strong> window
and expand <strong>All ports→ led_0</strong>.</p>
<p><img alt="../../_images/image99.png" src="../../_images/image99.png" /></p>
</li>
<li><p>Edit the led port settings as follows:</p>
<table>
<thead>
<tr class="header">
<th><blockquote>
<p><strong>Port Name</strong></p>
</blockquote></th>
<th><blockquote>
<p><strong>I/O Std</strong></p>
</blockquote></th>
<th><blockquote>
<p><strong>Package Pin</strong></p>
</blockquote></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Leds[3]</td>
<td>LVCMOS25</td>
<td><blockquote>
<p>P17</p>
</blockquote></td>
</tr>
<tr class="even">
<td><blockquote>
<p>Leds[2]</p>
</blockquote></td>
<td><blockquote>
<p>LVCMOS25</p>
</blockquote></td>
<td><blockquote>
<p>P18</p>
</blockquote></td>
</tr>
<tr class="odd">
<td><blockquote>
<p>Leds[1]</p>
</blockquote></td>
<td><blockquote>
<p>LVCMOS25</p>
</blockquote></td>
<td><blockquote>
<p>W10</p>
</blockquote></td>
</tr>
<tr class="even">
<td><blockquote>
<p>Leds[0]</p>
</blockquote></td>
<td><blockquote>
<p>LVCMOS25</p>
</blockquote></td>
<td><blockquote>
<p>V7</p>
</blockquote></td>
</tr>
</tbody>
</table><p>The following figure shows the completed led port settings in the I/O
Ports window.</p>
<p><img alt="../../_images/image100.png" src="../../_images/image100.png" /></p>
</li>
<li><p>Select <strong>Generate Bitstream</strong>.</p></li>
<li><p>The Save Project view opens. Ensure that the check box is selected
and then click <strong>Save</strong>.</p></li>
<li><p>If a message appears stating that Synthesis is Out-of-date, click
<strong>Yes</strong>.</p></li>
<li><p>After the bitstream generation completes, export the hardware and
launch the Vitis unified software platform as described in
<a class="reference external" href="2-using-zynq.md#exporting-a-hardware-platform">Exporting a Hardware Platform</a>.</p></li>
</ol>
<p><strong><em>Note</em>:</strong> Make sure to select <strong>Include bitstream</strong> instead of
<strong>Pre-synthesis</strong> on the <strong>Output</strong> page of the <strong>Export Hardware
Platform</strong> wizard.</p>
<p>##Linux-Based Device Driver Development</p>
<p>Modules in Linux are pieces of code that can be loaded and unloaded
into the kernel on demand. A piece of code that you add in this way is
called a loadable kernel module (LKM). These modules extend the
functionality of the kernel without the need to reboot the system.
Without modules, you would need to build monolithic kernels and add
new functionality directly into the kernel image. Besides having
larger kernels, this has the disadvantage of requiring you to rebuild
and reboot the kernel every time you want new functionality.</p>
<p>LKMs typically are one of the following things:</p>
<ul class="simple">
<li><p><strong>Device drivers:</strong> A device driver is designed for a specific piece
of hardware. The kernel uses it to communicate with that piece of
hardware without having to know any details of how the hardware
works.</p></li>
<li><p><strong>Filesystem drivers:</strong> A filesystem driver interprets the contents
of a file system as files and directories.</p></li>
<li><p><strong>System calls:</strong> User space programs use system calls to get
services from the kernel.</p></li>
</ul>
<p>On Linux, each piece of hardware is represented by a file named as a
device file, which provides the means to communicate with the
hardware. Most hardware devices are used for output as well as input,
so device files provide input/output control (ioctl) to send and
receive data to and from hardware. Each device can have its own ioctl
commands, which can be of the following types:</p>
<ul class="simple">
<li><p>read ioctl. These send information from a process to the kernel.</p></li>
<li><p>write ioctl. These return information to a process.</p></li>
<li><p>Both read and write ioctl.</p></li>
<li><p>Neither read nor write ioctl.</p></li>
</ul>
<p>For more details about LKM, refer to the <a href="http://tldp.org/LDP/lkmpg/2.6/html/index.html">Linux Kernel Module
Programming Guide</a>.</p>
<p>In this section you are going to develop a peripheral IP Device driver
as a LKM, which is dynamically loadable onto the running Kernel. You
must build peripheral IP LKM as part of the same kernel build process
that generates the base kernel image.</p>
<p><strong><em>Note</em>:</strong> If you do not want to compile the device driver, you can
skip the example of this section and jump to <a class="reference external" href="#loading-module-into-running-kernel-and-application-execution">Loading Module into
Running Kernel and Application Execution</a>. In that section, you can use the kernel image, which contains blink.ko (image.ub in the shared ZIP files). See <a class="reference external" href="2-using-zynq.md#design-files-for-this-tutorial">Design Files for This Tutorial</a>.</p>
<p>For kernel compilation and device driver development, you must use the
Linux workstation. Before you start developing the device driver, the
following steps are required:</p>
<ol class="simple">
<li><p>Set the toolchain path in your Linux Workstation.</p></li>
<li><p>Download the kernel source code and compile it. For downloading and
compilation, refer to the steps mentioned in the <a href="http://wiki.xilinx.com/zynq-linux">Xilinx Zynq Linux
Wiki Page</a>.</p></li>
</ol>
</div>
<div class="section" id="example-project-device-driver-development">
<h3>Example Project: Device Driver Development<a class="headerlink" href="#example-project-device-driver-development" title="Permalink to this headline">¶</a></h3>
<p>You will use a Linux workstation for this example project. The device
driver software is provided in the LKM folder of the ZIP file that
accompanies this guide. See <a class="reference external" href="2-using-zynq.md#design-files-for-this-tutorial">Design Files for This
Tutorial</a>.</p>
<ol>
<li><p>Under the PetaLinux project directory, use the command below to
create your module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">petalinux</span><span class="o">-</span><span class="n">create</span> <span class="o">-</span><span class="n">t</span> <span class="n">modules</span> \<span class="o">--</span><span class="n">name</span> <span class="n">mymodule</span> \<span class="o">--</span><span class="n">enable</span>
</pre></div>
</div>
<p>PetaLinux creates the module under the following directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>\<span class="o">&lt;</span><span class="n">plnx</span><span class="o">-</span><span class="n">project</span>\<span class="o">&gt;/</span><span class="n">project</span><span class="o">-</span><span class="n">spec</span><span class="o">/</span><span class="n">meta</span><span class="o">-</span><span class="n">user</span><span class="o">/</span> <span class="n">recipes</span><span class="o">-</span><span class="n">modules</span><span class="o">/</span>
</pre></div>
</div>
<p>For this exercise, create the “blink” module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">petalinux</span><span class="o">-</span><span class="n">create</span> <span class="o">-</span><span class="n">t</span> <span class="n">modules</span> \<span class="o">--</span><span class="n">name</span> <span class="n">blink</span> \<span class="o">--</span><span class="n">enable</span>
</pre></div>
</div>
<p>The default driver creation includes a Makefile, C-file, and readme
files. In our exercise, PetaLinux creates blink.c, Makefile, and
README files. It also contains bit bake recipe blink.bb.</p>
</li>
<li><p>Change the C-file (driver file) and the make file as per your
driver.</p></li>
<li><p>Take the LKM folder (reference files) and copy blink.c and blink.h
into this directory.</p></li>
<li><p>Open blink.bb recipe and add blink.h entry in SRC_URI.</p></li>
<li><p>Run the command <code class="docutils literal notranslate"><span class="pre">petalinux-build</span></code>.</p>
<p>After successful compilation the .ko file is created in the following
location:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">petalinux</span><span class="o">-</span><span class="n">build_directory</span><span class="o">&gt;/</span><span class="n">build</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">sysroots</span><span class="o">-</span><span class="n">components</span><span class="o">/</span><span class="n">zc702_zynq7</span><span class="o">/</span><span class="n">blink</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/</span><span class="mf">5.4</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">xilinx</span><span class="o">-</span><span class="n">v2020</span><span class="o">.</span><span class="mi">1</span><span class="o">/</span><span class="n">extra</span><span class="o">/</span><span class="n">blink</span><span class="o">.</span><span class="n">ko</span>
</pre></div>
</div>
</li>
<li><p>You can install the driver using the modprobe command, which will be
explained in further detail in the next section.</p></li>
</ol>
</div>
</div>
<div class="section" id="loading-module-into-running-kernel-and-application-execution">
<h2>Loading Module into Running Kernel and Application Execution<a class="headerlink" href="#loading-module-into-running-kernel-and-application-execution" title="Permalink to this headline">¶</a></h2>
<p>In this section you will boot Linux onto the Zynq SoC Board and load
the peripheral IP as a LKM onto it. You will develop the application
for the system and execute it onto the hardware</p>
<div class="section" id="loading-module-into-kernel-memory">
<h3>Loading Module into Kernel Memory<a class="headerlink" href="#loading-module-into-kernel-memory" title="Permalink to this headline">¶</a></h3>
<p>The basic programs for inserting LKMs are modprobe. The modprobe
command makes an init_module system call to load the LKM into kernel
memory. The init_module system call invokes the LKM initialization
routine immediately after it loads the LKM. As part of its
initialization routine, insmod passes to the address of the subroutine
to init_module.</p>
<p>In the peripheral IP device driver, you already set up init_module to
call a kernel function that registers the subroutines. It calls the
kernel’s register_chrdev subroutine, passing the major and minor
number of the devices it intends to drive and the address of its own
“open” routine among the arguments. The subroutine register_chrdev
specifies in base kernel tables that when the kernel wants to open
that particular device, it should call the open routine in your LKM.</p>
</div>
<div class="section" id="application-software">
<h3>Application Software<a class="headerlink" href="#application-software" title="Permalink to this headline">¶</a></h3>
<p>The main() function in the application software is the entry point for
the execution. It opens the device file for the peripheral IP and then
waits for the user selection on the serial terminal.</p>
<p>If you select the start option on the serial terminal, all four LEDs
start blinking. If you select the stop option, all four LEDs stop
blinking and retain the previous state.</p>
</div>
<div class="section" id="example-project-loading-a-module-into-kernel-and-executing-the-application">
<h3>Example Project: Loading a Module into Kernel and Executing the Application<a class="headerlink" href="#example-project-loading-a-module-into-kernel-and-executing-the-application" title="Permalink to this headline">¶</a></h3>
<div class="section" id="booting-linux-on-the-target-board">
<h4><em>Booting Linux on the Target Board</em><a class="headerlink" href="#booting-linux-on-the-target-board" title="Permalink to this headline">¶</a></h4>
<p>Boot Linux on the Zynq SoC ZC702 target board, as described in
<a class="reference external" href="6-linux-booting-debug.md#booting-linux-on-a-zynq-soc-board">Booting Linux on a Zynq SoC Board</a>.</p>
</div>
<div class="section" id="loading-modules-and-executing-applications">
<h4>Loading Modules and Executing Applications<a class="headerlink" href="#loading-modules-and-executing-applications" title="Permalink to this headline">¶</a></h4>
<p>In this section, you will use the Vitis software platform installed on
a Windows machine.</p>
<ol>
<li><p>Open the Vitis software platform. You must run the Target Communication Frame (TCF) agent on the host machine.</p></li>
<li><p>In the XSCT Console view, type <code class="docutils literal notranslate"><span class="pre">connect</span></code> to connect to the Xilinx Software Command-Line Tool (XSCT).</p></li>
<li><p>In the Vitis software platform, select <strong>File → New → Application
Project</strong> to open the New Application Project wizard.</p></li>
<li><p>Use the information in the table below to make your selections in
the wizard screens.</p>
<table>
<thead>
<tr class="header">
<th><blockquote>
<p><strong>Wizard Screen</strong></p>
</blockquote></th>
<th><blockquote>
<p><strong>System Property</strong></p>
</blockquote></th>
<th><blockquote>
<p><strong>Setting or Command to Use</strong></p>
</blockquote></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Platform</td>
<td>Select a platform from repository</td>
<td>Click <strong>hw_platform [custom]</strong>.</td>
</tr>
<tr class="even">
<td>Application Project Details</td>
<td>Application project name</td>
<td>Enter linux_blinkled_app</td>
</tr>
<tr class="odd">
<td></td>
<td>Select target processor for the Application project</td>
<td>Select <strong>ps7_cortexa9 SMP</strong>.</td>
</tr>
<tr class="even">
<td>Domain</td>
<td>Select a domain</td>
<td>Click <strong>linux_application_domain</strong>.</td>
</tr>
<tr class="odd">
<td></td>
<td>Application settings</td>
<td>If known, enter the sysroot, root FS, and kernel image paths. Otherwise, leave these options blank.</td>
</tr>
<tr class="even">
<td>Templates</td>
<td>Available Templates</td>
<td>Linux Empty Application</td>
</tr>
</tbody>
</table></li>
<li><p>Click <strong>Finish</strong>. The New Application Project wizard closes and the Vitis software platform creates the linux_blinkled_app project under the Explorer view.</p></li>
<li><p>In the Explorer view, expand the <strong>linux_blinkled_app</strong> project,
right-click the <strong>src</strong> directory, and select <strong>Import</strong>. The Import Sources view opens.</p></li>
<li><p>Browse for LKM_App folder and select linux_blinkled_app.c and
blink.h files.</p>
<p><strong><em>Note</em>:</strong> The application software file name for the system is
linux_blinkled_app.c and the header file name is blink.h. These files
are available in the LKM folder of the ZIP file that accompanies this
guide. See <a class="reference external" href="2-using-zynq.md#design-files-for-this-tutorial">Design Files for This
Tutorial</a>. Add the
linux_blinkled_app.c and blink.h files.</p>
</li>
<li><p>Click <strong>Finish</strong>.</p>
<p>Right-click on linux_blinkled_app project and select <strong>Build Project</strong>
to generate linux_blinkled_app.elf file in binary folders. Check the
console window for the status of this action.</p>
</li>
<li><p>Connect the board.</p></li>
<li><p>Because you have a bitstream for the PL fabric, you must download
the bitstream. Select <strong>Xilinx → Program FPGA</strong>. The Program FPGA view opens. It displays the bitstream exported from Vivado.</p></li>
<li><p>Click <strong>Program</strong> to download the bitstream and program the PL
fabric.</p></li>
<li><p>Follow the steps described in <a class="reference internal" href="6-linux-booting-debug.html"><span class="doc">Linux Booting and Debug in
the Vitis Software Platform</span></a> to load the Linux image
and start it.</p>
<p>After the kernel boots successfully, in a serial terminal, navigate to /lib/modules/&lt;kernel-version&gt;/extra and run the command:</p>
<p><code class="docutils literal notranslate"><span class="pre">modprobe</span> <span class="pre">blink.ko</span></code></p>
<p>You will see the following message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="n">Hello</span> <span class="n">module</span> <span class="n">world</span><span class="o">.</span>
<span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="n">Module</span> <span class="n">parameters</span> <span class="n">were</span> <span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;default&quot;</span>
<span class="n">blink_init</span><span class="p">:</span> <span class="n">Registers</span> <span class="n">mapped</span> <span class="n">to</span> <span class="n">mmio</span> <span class="o">=</span> <span class="mh">0xf09f4000</span>
<span class="n">Registration</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">success</span> <span class="n">the</span> <span class="n">major</span> <span class="n">device</span> <span class="n">number</span> <span class="ow">is</span> <span class="mf">244.</span>
</pre></div>
</div>
<p>If you want to talk to the device driver, create a device file by
running the following command:</p>
<p><code class="docutils literal notranslate"><span class="pre">mknod</span> <span class="pre">/dev/blink_Dev</span> <span class="pre">c</span> <span class="pre">244</span> <span class="pre">0</span></code></p>
<p>The device file name is important, because the ioctl program assumes
that is the file you will use.</p>
</li>
<li><p>Create a device node. Run the mknod command and select the the
string from the printed message.</p>
<p>For example, the command <strong>mknod /dev/blink_Dev c 244 0</strong> creates the /dev/blink_Dev node.</p>
</li>
<li><p>Select <strong>Window→ Open perspective → Remote System Explorer</strong> and
click <strong>Open</strong>. The Vitis software platform opens the Remote
Systems Explorer perspective.</p></li>
<li><p>In the Remote Systems view, do the following:</p>
<p>a.  Right-click and select <strong>New → Connection</strong> to open the New
Connection wizard.</p>
<p>b.  Select the <strong>SSH Only</strong> and click <strong>Next</strong>.</p>
<p>c.  In the Host name field, type the target board IP. To determine the target IP, type ifconfig eth0 at the Zynq prompt in the serial terminal. The target IP assigned to the board displays.</p>
<p>d.  Set the connection name as blink and type a description.</p>
<p>e.  Click <strong>Finish</strong> to create the connection.</p>
<p>f.  Expand <strong>blink → sftp Files→ Root</strong>. The Enter Password wizard
opens.</p>
<p>g.  Enter the User ID and Password (<strong>root/root</strong>); select the <strong>Save
user ID</strong> and <strong>Save password</strong> options.</p>
<p>h.  Click <strong>OK</strong>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">The</span> <span class="n">window</span> <span class="n">displays</span> <span class="n">the</span> <span class="n">root</span> <span class="n">directory</span> <span class="n">content</span><span class="p">,</span> <span class="n">because</span> <span class="n">you</span> <span class="n">previously</span>
<span class="n">established</span> <span class="n">the</span> <span class="n">connection</span> <span class="n">between</span> <span class="n">the</span> <span class="n">Windows</span> <span class="n">host</span> <span class="n">machine</span> <span class="ow">and</span> <span class="n">the</span>
<span class="n">target</span> <span class="n">board</span><span class="o">.</span>
</pre></div>
</div>
<p>i.  Right-click the <strong>/</strong> in the path name and create a new directory;
name it Apps.</p>
<p>j.  Using the Remote System explorer perspective, copy the
linux_blinkled_app.elf file from the &lt;project-dir&gt;
linux_blinkled_app/Debug folder and paste it into the /Apps
directory under <strong>blink connection</strong>.</p>
</li>
<li><p>In the serial terminal, type cd Apps at the Zynq\prompt to open
the /Apps directory.</p></li>
<li><p>Go to the Apps directory at the root&#64;xilinx-zc702-2020_1: Linux
prompt, and type chmod 777 linux_blinkled_app.elf to change the
linux_blinkled_app.elf file mode to executable mode.</p></li>
<li><p>At the root&#64;xilinx-zc702-2020_1: prompt, type
./linux_blinkled_app.elf to execute the application.</p></li>
<li><p>Follow the instruction printed on the serial terminal to run the
application. The application asks you to enter 1 or 0 as input.</p>
<ul class="simple">
<li><p>Type 1, and observe the LEDs DS15, DS16, DS17, and DS18. They start
glowing.</p></li>
<li><p>Type 0, and observe that the LEDs stop at their state. No more
blinking changes. Repeat your inputs and observe the LEDs.</p></li>
</ul>
</li>
<li><p>After you finish debugging the Linux application, close the Vitis
software platform.</p></li>
</ol>
<p>© Copyright 2015–2020 Xilinx, Inc.</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
<!-- Atalwar: Moved the footer code to layout.html to resolve conflict with the Xilinx template -->
</footer>

        </div>
      </div>


	  <!-- Sphinx Page Footer block -->
  

  <hr/>

  <div role="contentinfo" class="copyright">
    <p class="footerinfo">
      <span class="lastupdated">
        Last updated on January 19, 2021.
      </span>

    </p>
	<br>
  </div>
      </div>
    </section>


  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

   <script type="text/javascript">
    jQuery(function() { Search.loadIndex("searchindex.js"); });
  </script>

  <script type="text/javascript" id="searchindexloader"></script>


  
  
    
  



  <!--  Xilinx template footer block -->
							</div>
						</div>
					</div>
				</div>
				<div class="xilinxExperienceFragments experiencefragment aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16">
					<div class="xf-content-height">
						<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 ">
							<div class="footer parbase aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16">
								<noindex>
                  <!-- make footer fixed - NileshP -->
                  <style>
                        .footer {
                        position: fixed;
                        left: 0;
                        bottom: 0;
                        width: 100%;
                        }
                  </style>
                  <!-- make footer fixed NileshP-->
									<footer>
										<div class="aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid sub-footer">
													<div class="row">
														<div class="footerSocial parbase">
															<div class="col-md-push-6 col-lg-push-6 col-md-6 col-lg-6">
																<ul class="list-inline pull-right social-menu">
																	<li>
																		<a href="https://www.linkedin.com/company/xilinx">
																		<span class="linkedin icon"></span>
																		<span class="sr-only">Connect on LinkedIn</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.twitter.com/XilinxInc">
																		<span class="twitter icon"></span>
																		<span class="sr-only">Follow us on Twitter</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.facebook.com/XilinxInc">
																		<span class="facebook icon"></span>
																		<span class="sr-only">Connect on Facebook</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.youtube.com/XilinxInc">
																		<span class="youtube icon"></span>
																		<span class="sr-only">Watch us on YouTube</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.xilinx.com/registration/subscriber-signup.html">
																		<span class="newsletter icon"></span>
																		<span class="sr-only">Subscribe to Newsletter</span>
																		</a>
																	</li>
																</ul>
															</div>
														</div>
														<div class="col-md-pull-6 col-lg-pull-6 col-md-6 col-lg-6">
															<span class="copyright">
                                  
                                  &copy; 2020, Xilinx
                              </span>
															<ul class="list-inline sub-menu">
																<li>
																	<a href="https://www.xilinx.com/about/privacy-policy.html">Privacy</a>
																</li>
																<li>
																	<a href="https://www.xilinx.com/about/legal.html">Legal</a>
																</li>
																<li>
																	<a href="https://www.xilinx.com/about/contact.html">Contact</a>
																</li>
															</ul>
														</div>
													</div>
												</div>
											</div>
										</div>
									</footer>
								</noindex>
							</div>
						</div>
					</div>
				</div>
				<div class="quicklinks parbase aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16">
					<noindex>
						<span class="quickLinks">
							<ul>
								<li>
									<a href="#top" class="btn backToTop">
									<span class="fas fa-angle-up" aria-hidden="true"></span>
									</a>
								</li>
							</ul>
						</span>
					</noindex>
				</div>
			</div>
		</div>
		<script>window.CQ = window.CQ || {}</script>
		<script src="https://static.cloud.coveo.com/searchui/v2.4382/js/CoveoJsSearch.Lazy.min.js"></script>
		<script>
			var underscoreSetup = function () {
			  _.templateSettings.interpolate = /\{\{=([^-][\S\s]+?)\}\}/g;
			  _.templateSettings.evaluate = /\{\{([^-=][\S\s]+?)\}\}/g;
			  _.templateSettings.escape = /\{\{-([^=][\S\s]+?)\}\}/g;
			}

			underscoreSetup();
		</script>
	</body>
</html>